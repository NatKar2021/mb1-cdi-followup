---
title: "Processing manybabies cdi project"
author: "Natalia"
date: "07/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "")
getwd()
```

# Load Libraries

```{r libraries, echo=FALSE, include=FALSE}
library(readxl)
library(plyr)
library(ggplot2)
library(powerAnalysis)
library(ggpubr)
library(DataCombine)
library(tidyverse)
library(stringr)
library(data.table)
library(PerformanceAnalytics)
library(WRS2)
library(dplyr)
library(MASS)
```

## Load data

```{r load data, echo=FALSE, include=FALSE}
rm(list = ls())

# Load data from Excel
d1 <- read.csv("02b_processed.csv") # indicate the file name and sheet number 

# Examine the outcomes of variables
summary(d1)
# Load percentiles for countries 
korean<-read.delim('korean.txt', header=F)
# Rename the header with column names
colnames(korean) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(korean[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(korean)
# Add a column for Age in days
korean$Age<-c(1:max_age_CDI1)

oxford<-read.delim('oxford.txt', header=F)
colnames(oxford) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(oxford[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(oxford)
# Add a column for Age in days
oxford$Age<-c(1:max_age_CDI1)

web_cdi<-read.delim('web_cdi.txt', header=F)
colnames(web_cdi) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(web_cdi[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(web_cdi)
# Add a column for Age in days
web_cdi$Age<-c(1:max_age_CDI1)

norwegian<-read.delim('norwegian.txt', header=F)
colnames(norwegian) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(norwegian[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(norwegian)
# Add a column for Age in days
norwegian$Age<-c(1:max_age_CDI1)

german<-read.delim('german.txt', header=F)
colnames(german) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(german[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(german)
# Add a column for Age in days
german$Age<-c(1:max_age_CDI1)

#dutch<- No norms
french<-read.delim('french.txt', header=F)
colnames(french) <- c(1:99)
# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(french[,1] != 0)[1]
# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(french)
# Add a column for Age in days
french$Age<-c(1:max_age_CDI1)

```

## Compute CDI in percentiles for production

```{r Compute CDI in percentiles for production, include=FALSE}
prod_T1<-c()

for(i in 1:nrow(d1))  

  {tool <- d1[[i,"CDI.form"]]
    
    if((tool == "O-CDI"))
    {perc_CDI1_prod<-oxford}

    if((tool == "FRAKIS"))
    {perc_CDI1_prod<-german}

    if((tool == "webCDI"))
    {perc_CDI1_prod<-web_cdi}

    if((tool == "NorCDI"))
    {perc_CDI1_prod<-norwegian}
    
    if((tool == "K-CDI"))
    {perc_CDI1_prod<-korean}

    if((tool == "French European"))
    {perc_CDI1_prod<-french}

# Get the minimum age for the CDI instrument
min_age_CDI1 <- which(perc_CDI1_prod[,1] != 0)[1]

# Get the maximal age for the CDI instrument
max_age_CDI1 <- nrow(perc_CDI1_prod)

# Get percentiles for production (both for CDI-I[WG] and CDI-II[WS])
score <- as.numeric(d1 [[i,"vocab_nwords"]])
age<-as.numeric(d1[[i,"CDI.agedays"]])

    if(age > max_age_CDI1)# adjust for the age limits in the sample-specific norming data
    {
      age =  max_age_CDI1
    }
    
    if(age < min_age_CDI1)# adjust for the age limits in the sample-specific norming data
    {
      age =  min_age_CDI1
    }

      # get the number of line with the corresponding age
      age_row <- as.numeric(which(perc_CDI1_prod$Age==age))
      # get the number of the column containing the min value between the CDI score and the value in the age corresponding line
      perc <- as.numeric(which.min(abs(perc_CDI1_prod[age_row,c(1:99)]-score))) 
      
      if (score==0)
      {perc=1}

if((tool == "FROSCH" || tool == "NCDI"))
    {perc<-NA}

  prod_T1 <- c(prod_T1,perc)

}
      
# Add a column for the CDI production score in percentiles for T1
d1$percentile<-prod_T1

```

## Add swiss data and visualize

```{r echo=FALSE, include=FALSE}
swiss_data<-read.delim("zurich_data.txt", header=T)
swiss_data$CDI.agerange<-NA
swiss_data$CDI.error<-FALSE
names(swiss_data)[names(swiss_data) == "percentile"] <- "percentile_2"
swiss_data1<- swiss_data[c("subid", "CDI.agedays","percentile_2")]
final_swiss<-d1[d1$labid=="weltentdeckerzurich",]
d1<-d1[!d1$labid=="weltentdeckerzurich",]
final_swiss<-inner_join(final_swiss, swiss_data1)
final_swiss$percentile<-NULL
names(final_swiss)[names(final_swiss) == "percentile_2"] <- "percentile"

# Add swiss data to the final sample
d1_total<-rbind(d1, final_swiss)

write.table(d1_total,"percentiles_manybabies_cdi.txt",sep="\t",row.names=FALSE, quote = FALSE)

```

